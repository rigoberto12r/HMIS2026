apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-scripts
  namespace: hmis
data:
  backup-db.sh: |
    #!/bin/bash
    # Inline backup script for Kubernetes
    set -euo pipefail

    echo "[$(date)] Starting PostgreSQL backup..."

    # Configuration from environment variables
    BACKUP_DIR="/backups/postgres"
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_NAME="hmis_backup_${TIMESTAMP}"

    mkdir -p "$BACKUP_DIR"

    # Create backup using pg_dump
    PGPASSWORD="$POSTGRES_PASSWORD" pg_dump \
      -h "$POSTGRES_HOST" \
      -p "$POSTGRES_PORT" \
      -U "$POSTGRES_USER" \
      -d "$POSTGRES_DB" \
      -Fc \
      -f "${BACKUP_DIR}/${BACKUP_NAME}.dump"

    # Compress backup
    gzip "${BACKUP_DIR}/${BACKUP_NAME}.dump"

    # Upload to S3
    if [ -n "${S3_BUCKET:-}" ]; then
      aws s3 cp "${BACKUP_DIR}/${BACKUP_NAME}.dump.gz" \
        "s3://${S3_BUCKET}/postgres/${BACKUP_NAME}.dump.gz" \
        --storage-class STANDARD_IA
      echo "Backup uploaded to S3"
    fi

    # Cleanup old backups (keep last 30 days)
    find "$BACKUP_DIR" -name "hmis_backup_*.dump.gz" -mtime +30 -delete

    echo "[$(date)] Backup completed: ${BACKUP_NAME}"

  backup-redis.sh: |
    #!/bin/bash
    # Inline Redis backup script for Kubernetes
    set -euo pipefail

    echo "[$(date)] Starting Redis backup..."

    BACKUP_DIR="/backups/redis"
    TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
    BACKUP_NAME="redis_backup_${TIMESTAMP}"

    mkdir -p "$BACKUP_DIR"

    # Build redis-cli command
    REDIS_CLI="redis-cli -h $REDIS_HOST -p $REDIS_PORT"
    if [ -n "${REDIS_PASSWORD:-}" ]; then
      REDIS_CLI="$REDIS_CLI -a $REDIS_PASSWORD"
    fi

    # Trigger BGSAVE
    $REDIS_CLI BGSAVE

    # Wait for BGSAVE to complete
    sleep 5

    # Copy RDB file from Redis pod (requires kubectl or shared volume)
    # This assumes Redis data is mounted to /data/redis
    if [ -d "/data/redis" ]; then
      cp /data/redis/dump.rdb "${BACKUP_DIR}/${BACKUP_NAME}.rdb"
      gzip "${BACKUP_DIR}/${BACKUP_NAME}.rdb"

      # Upload to S3
      if [ -n "${S3_BUCKET:-}" ]; then
        aws s3 cp "${BACKUP_DIR}/${BACKUP_NAME}.rdb.gz" \
          "s3://${S3_BUCKET}/redis/${BACKUP_NAME}.rdb.gz"
        echo "Redis backup uploaded to S3"
      fi
    fi

    # Cleanup old backups
    find "$BACKUP_DIR" -name "redis_backup_*.rdb.gz" -mtime +7 -delete

    echo "[$(date)] Redis backup completed"

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: hmis
spec:
  # Run daily at 2 AM UTC
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          serviceAccountName: backup-sa
          containers:
          - name: backup
            image: postgres:16-alpine
            command: ["/bin/bash", "/scripts/backup-db.sh"]
            env:
            - name: POSTGRES_HOST
              value: "postgres-service"
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DB
              value: "hmis"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: password
            - name: S3_BUCKET
              value: "hmis-backups"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret_access_key
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
            - name: backup-storage
              mountPath: /backups
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-scripts
              defaultMode: 0755
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: redis-backup
  namespace: hmis
spec:
  # Run every hour
  schedule: "0 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          serviceAccountName: backup-sa
          containers:
          - name: backup
            image: redis:7-alpine
            command: ["/bin/sh", "/scripts/backup-redis.sh"]
            env:
            - name: REDIS_HOST
              value: "redis-service"
            - name: REDIS_PORT
              value: "6379"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-secret
                  key: password
                  optional: true
            - name: S3_BUCKET
              value: "hmis-backups"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret_access_key
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
            - name: backup-storage
              mountPath: /backups
            - name: redis-data
              mountPath: /data/redis
              readOnly: true
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-scripts
              defaultMode: 0755
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
          - name: redis-data
            persistentVolumeClaim:
              claimName: redis-data-pvc
              readOnly: true

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-verification
  namespace: hmis
spec:
  # Run daily at 4 AM UTC (2 hours after backup)
  schedule: "0 4 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          serviceAccountName: backup-sa
          containers:
          - name: verify
            image: postgres:16-alpine
            command: ["/bin/bash", "-c"]
            args:
            - |
              echo "Verifying backups..."

              # Check PostgreSQL backups
              PG_BACKUP_COUNT=$(find /backups/postgres -name "hmis_backup_*.dump.gz" -mtime -1 | wc -l)
              if [ "$PG_BACKUP_COUNT" -gt 0 ]; then
                echo "✓ PostgreSQL backup found (last 24h)"
              else
                echo "✗ No recent PostgreSQL backup!"
                exit 1
              fi

              # Check Redis backups
              REDIS_BACKUP_COUNT=$(find /backups/redis -name "redis_backup_*.rdb.gz" -mtime -1 | wc -l)
              if [ "$REDIS_BACKUP_COUNT" -gt 0 ]; then
                echo "✓ Redis backup found (last 24h)"
              else
                echo "✗ No recent Redis backup!"
                exit 1
              fi

              # Check S3 sync
              if aws s3 ls s3://${S3_BUCKET}/postgres/ | grep -q hmis_backup; then
                echo "✓ PostgreSQL backups in S3"
              fi

              if aws s3 ls s3://${S3_BUCKET}/redis/ | grep -q redis_backup; then
                echo "✓ Redis backups in S3"
              fi

              echo "Backup verification completed successfully"
            env:
            - name: S3_BUCKET
              value: "hmis-backups"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access_key_id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret_access_key
            - name: AWS_DEFAULT_REGION
              value: "us-east-1"
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
              readOnly: true
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-pvc
              readOnly: true

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
  namespace: hmis
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: standard

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-sa
  namespace: hmis

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backup-role
  namespace: hmis
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: backup-rolebinding
  namespace: hmis
subjects:
- kind: ServiceAccount
  name: backup-sa
  namespace: hmis
roleRef:
  kind: Role
  name: backup-role
  apiGroup: rbac.authorization.k8s.io
